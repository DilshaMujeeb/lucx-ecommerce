<body>
	<main class="main">
		<section class="mt-50 mb-50">
			<div class="container">
				<form id="checkout-form">

					<input type="text" name="userId" id="" value="<%= usern._id %>" hidden>
					<% if (usern) { %>
						<input required="" class="form-control square" name="Name" type="text"
							value="<%= usern.username %>" hidden>
						<input required="" class="form-control square" name="phone" type="phone"
							value="<%= usern.phoneNumber %>" hidden>
						<input required="" class="form-control square" name="Email" type="email"
							value="<%= usern.email %>" hidden>
						<% } %>

							<div class="row">
								<div class="col-md-6">
									<div class="mb-25">
										<h3>Checkout</h3>

									</div>

									<div class="mb-25">
										<a href="/placeorder-address" class="btn btn-primary">Add address</a>
									</div>

									<div class="payment_method">
										<div class="mb-25">
											<h5>Select a delivery address</h5>
										</div>
										<div class="payment_option">





											<div class="container">
												<div class="row">
													<% address.forEach(function(address){ %>
														<div class="col-lg-6 mt-10">
															<div class="payment_method">
																<div class="payment_option">
																	<div class="custome-radio">
																		<input class="form-check-input" required="" type="radio"
																			name="address"
																			value="<%= address._id %>" id="<%= address._id %>" checked>
																			<label class="form-check-label" for="<%= address._id %>"
																				data-bs-toggle="collapse"
																				data-target="#checkPayment" aria-controls="checkPayment">
																				<div class="card">
																					<div class="card-header">
																						<h5 class="mb-0"></h5>
																					</div>
																					<div class="card-body">
																						<address>
																							name: <%= address.name %><br>
																								phone: <%= address.phone %><br>
																									address: <%= address.homeAddress1 %><br>
																										address2: <%= address.homeAddress2 %><br>
																											city: <%= address.city %><br>
																												state: <%= address.state %>
																												</address>
																												pincode: <p><%= address.zip %></p>

																												</div>
																											</div>
																										</label>
																									</div>
																								</div>
																							</div>
																						</div>
																						<% }); %>
																						</div>
																					</div>
																				</div>
																				<div class="row">
																					<div class="ship_detail">
																						<div class="form-group">
																							<div class="chek-form">
																								<div class="custome-checkbox">
																									<input class="form-check-input" type="checkbox"
																										name="checkbox" id="differentaddress">
																								</div>
																							</div>
																						</div>
																						<div id="collapseAddress" class="different_address
																							collapse in">
																						</div>
																					</div>
																				</div>
																			</div>
																		</div>











																		<div class="col-md-6">
																			<div class="order_review">
																				<div class="mb-20">
																					<h4>Your Orders</h4>
																				</div>
																				<div class="table-responsive order_table text-center">
																					<table class="table">
																						<thead>
																							<tr>
																								<th colspan="2">Product</th>
																								<th>Total</th>
																							</tr>
																						</thead>
																						<tbody>
																							<% products.forEach(function(products) { %>
																								<tr>
																									<td class="image product-thumbnail"><img src="/uploads/<%=
																											products.proDetails[0].Image[0] %>" alt="#">
																									</td>
																									<td>
																										<h5><a href="#"><%= products.proDetails[0].Productname
																													%></a></h5> <span
																												class="product-qty">x
																												<span id="#"><%= products.products.quantity %></span></span>
																											</td>


																											<td>₹<%= products.subtotal %></td>
																												<% }); %>
																												</tr>

																												<!-- <th>SubTotal</th>
								   <td class="product-subtotal" colspan="2"> ₹<span id="total"><%= products.subtotal %></span></td> -->
																											</tr>
																											<tr>
																												<th>Shipping</th>
																												<td colspan="2"><em>Free Shipping</em></td>
																											</tr>
																											 <tr>
                                        																	    <th>Coupon Discount</th>
                                        																	    <td colspan="2" id="couponDiscount"> ₹<span id="couponDiscountValue">0</span></td>

                                        																	</tr>
																											<tr>
																												<th>Total</th>
																												<td colspan="2" class="product-subtotal"
																													name="total"> ₹<span id="total"><%=locals.total%></span>
																													</td>
																												</tr>
																											</tbody>
																										</table>
																									</div>

																									<div class="row p-2 m-3" style="border:1px solid
																										rgb(227, 224,
																										224);border-radius:.5rem;background-color:rgb(246,
																										246, 246);">
																										<div class="col-lg-6">
																											<div class="toggle_info">
																												<span><i class="fi-rs-label mr-10"></i><span
																														class="text-muted">Have a coupon?</span> <a
																														href="#coupon" data-bs-toggle="collapse"
																														class="collapsed" aria-expanded="false">Click here</a></span>
																											</div>
																											<div class="panel-collapse collapse coupon_form "
																												id="coupon">
																												<div class="">
																													<p class="mb-30 font-sm">If you have a coupon code,
																														please apply it below.</p>

																													<!-- <div class="d-flex"> -->
																													<input class="form-control" id="couponCode"
																														type="text" oninput="this.value=
																														this.value.toUpperCase()"
																														style="text-transform:uppercase;width:fit-content;border:1px solid blue;background-color: aliceblue;"
																														maxlength="15">
																													<!-- <div class="btn btn-secondary" onclick="removeCoupon()" style="margin-left:.3rem;border-radius:50%;cursor:pointer;">X</div> -->
																													<!-- </div> -->
																													<p class="text-success m-1" id="validCoupon"></p>
																													<p class="text-danger m-1" id="invalidCoupon"></p>
																													<div>
																														<!-- <button type="button" class="btn btn-primary mt-2" style="cursor:pointer" href='/apply-coupon'>Apply Coupon</button> -->

																														<div class="btn btn-primary mt-2"
																															style="cursor:pointer" onclick="addCoupon('<%= usern._id %>')">Apply
																															Coupon</div> 
																													</div>

																												</div>
																											</div>
																										</div>
																									</div>




																									<div class="bt-1 border-color-1 mt-30 mb-30"></div>
																									<div class="payment_method" name="paymentmethod">
																										<div class="mb-25">
																											<h5>Payment</h5>
																										</div>
																										<div class="payment_option">
																											<div class="custome-radio">
																												<input class="form-check-input" required=""
																													type="radio" name="paymentMethod" value="COD"
																													id="exampleRadios3" checked="">
																												<label class="form-check-label" for="exampleRadios3"
																													data-bs-toggle="collapse"
																													data-target="#bankTranfer"
																													aria-controls="bankTranfer">Cash On Delivery</label>
																												<div class="form-group collapse in"
																													id="bankTranfer">
																													<p class="text-muted mt-5">There are many
																														variations of passages of Lorem Ipsum available,
																														but
																														the
																														majority have suffered alteration. </p>
																												</div>
																											</div>
																											<div class="custome-radio">
																												<input class="form-check-input" required=""
																													type="radio" name="paymentMethod" value="ONLINE"
																													id="exampleRadios4" checked="">
																												<label class="form-check-label" for="exampleRadios4"
																													data-bs-toggle="collapse"
																													data-target="#checkPayment"
																													aria-controls="checkPayment">Online Payment</label>
																												<div class="form-group collapse in"
																													id="checkPayment">
																													<p class="text-muted mt-5">Please send your cheque
																														to Store Name, Store Street, Store Town,
																														Store
																														State / County, Store Postcode. </p>
																												</div>
																											</div>

																										</div>
																									</div>
																									<button type="button" onclick="submitAjax()" class="btn
																										btn-fill-out btn-block mt-30">Place your order</button>
																								</div>
																							</div>
																						</div>


																					</form>
																				</div>
																			</section>
																		</main>
																	</body>

																	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
																	
																	<script>
																		function addCoupon(userId) {
  const couponCode = document.getElementById("couponCode").value;
const total = document.getElementById("total").innerText;
console.log(userId,"coupon");


$.ajax({
  url: "/apply-coupon/" ,
  method: "POST",
  data: {
	code:couponCode,
	total:total,
	user:userId
	

  },
  success: function (response) {
    // Handle successful response
	  if (response.success) {
        document.getElementById('validCoupon').innerText = 'Coupon applied successfully';
        document.getElementById('invalidCoupon').innerText = '';
        // document.getElementById('couponDiscount').innerText = response.discount;
		document.getElementById("couponDiscount").innerText = "₹" + response.discount;
        document.getElementById('total').innerText = response.newTotal;
      } else {
        document.getElementById('invalidCoupon').innerText = response.message;
        document.getElementById('validCoupon').innerText = '';
        document.getElementById('couponDiscount').innerText = '0';
        document.getElementById('total').innerText = total;
      }

  },
  error: function (error) {
    // Handle error
	console.log(error);
      document.getElementById('invalidCoupon').innerText = 'Error applying coupon';
      document.getElementById('validCoupon').innerText = '';
      document.getElementById('couponDiscount').innerText = '0';
      document.getElementById('total').innerText = total;

  },
});


}

																	</script>
																	
																	
																	
																	
																	
																	
																	<script>
				
			//---------------------------------------------------	
				function submitAjax(){

					console.log('test ajax');
					swal({
						title:'are you sure',
						text:'do you want to confirm',
						icon:'success',
						buttons:true,
						dangerMode:true,
					}).then((isConfirm)=>{
						if(isConfirm){
                          $.ajax({
						url:'/place-order',
						method:'post',
						data:$('#checkout-form').serialize(),
						success:(response)=>{
						   console.log('its here')
						   
						   console.log('res',response)
						   if(response.codSuccess){
							
  								
									deleteCart()
  								   console.log('Order placed ')
							       location.href='order-success'
 								
									
 								 
             			
							
						   }
						   else{
							
  								
									
  								  razorpayPayment(response);
								  
 								 
									
      							
 								 }
             			
							  
						   }
					   })
						}
					})
					
					
					
					
					
					
					
					}
				   

				

//------------------------------------------------------------------------
				
				function deleteCart() {
 				 return new Promise((resolve, reject) => {
 				   fetch("/deleteCart", { method: "POST" }).then(response => response.json())
 				   .then(data => {
 				     resolve(data);
 				   })
 				   .catch(error => {
 				     reject(error);
 				   });
 				 });
				}
				
					
			   function razorpayPayment(order){
				console.log("hheeeeeeeeeeeeeeelllllllllllooooooo");
				var options = {
					"key": 'rzp_test_JVphB4kr5MLSJN', // Enter the Key ID generated from the Dashboard
					"amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
					"currency": "INR",
					"name": "Evara", //your business name
					"description": "Test Transaction",
					"image": "/assets/imgs/theme/logo.svg",
					"order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
					"handler": function (response) {
			  
			  
					  verifyPayment(response, order)
					  deleteCart()
					},
					"prefill": {
					  "name": "Gaurav Kumar", //your customer's name
					  "email": "gaurav.kumar@example.com",
					  "contact": "9000090000"
					},
					"notes": {
					  "address": "Razorpay Corporate Office"
					},
					"theme": {
					  "color": "#3399cc"
					}
				  };
				  var rzp1 = new Razorpay(options);
				  rzp1.open();
			  
			 }
			 function verifyPayment(payment, order) {
				console.log("veeeeerrrrrrrrided");
				$.ajax({
				  url: '/verify-payment',
				  data: {
					payment,
					order
				  },
				  method: 'post',
				  success: (response) => {
					console.log(response,"haaaaaaaiiiii")
					if (response.status) {
					  swal({
						title: 'Success!',
						text: 'Your payment has been verified.',
						icon: "success",
						}).then(() => {
						location.href = '/order-success';
					  });
					} else {
					  Swal.fire({
						title: 'Error!',
						text: 'Your payment failed.',
						icon: 'error',
						confirmButtonText: 'OK'
					  });
					}
				  }
				});
			  }

			  

				
				

		

	    </script>